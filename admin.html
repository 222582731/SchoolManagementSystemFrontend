<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - SchoolMS</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f6f8;display:flex}
header, nav, section{box-sizing:border-box}
.sidebar{width:220px;background:#2c3e50;color:white;height:100vh;position:fixed;display:flex;flex-direction:column}
.sidebar h2{text-align:center;padding:20px 0;border-bottom:1px solid #3e4e5e;margin:0}
.sidebar ul{list-style:none;padding:0;margin:0;flex:1}
.sidebar ul li{border-bottom:1px solid #3e4e5e}
.sidebar ul li a{display:block;padding:15px 20px;color:white;text-decoration:none;transition:0.3s}
.sidebar ul li a:hover, .sidebar ul li a.active{background:#2980b9}
.main{margin-left:220px;padding:20px;flex:1}
header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:10px 20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:sticky;top:0;z-index:1000}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;box-shadow:0 3px 6px rgba(0,0,0,0.1);border-radius:10px;overflow:hidden}
table th, table td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
table th{background:#2c3e50;color:white}
button{padding:5px 10px;border:none;border-radius:5px;cursor:pointer}
.addBtn{background:#2980b9;color:white;margin-bottom:15px}
.deleteBtn{background:#e74c3c;color:white}
.card-container{display:flex;gap:20px;margin-top:20px;flex-wrap:wrap}
.card{background:#fff;padding:20px;border-radius:10px;flex:1;min-width:150px;box-shadow:0 3px 6px rgba(0,0,0,0.1);text-align:center}
.card h3{margin-top:0}
#toast{visibility:hidden;min-width:200px;background:#27ae60;color:white;text-align:center;border-radius:8px;padding:10px;position:fixed;bottom:20px;right:20px;opacity:0;transition:opacity 0.5s,visibility 0.5s}
#toast.show{visibility:visible;opacity:1}
.message-container{margin-top:20px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.1)}
.message-container h3{margin-top:0}
.message-list{max-height:200px;overflow-y:auto;margin-bottom:10px;padding:5px;border:1px solid #ddd;border-radius:5px;background:#f9f9f9}
.message-list p{margin:5px 0}
.message-input{display:flex;gap:10px;margin-top:10px}
.message-input input{flex:1;padding:8px;border-radius:5px;border:1px solid #ccc}
.message-input button{padding:8px 15px;border-radius:5px;background:#2980b9;color:white;border:none;cursor:pointer}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Admin Panel</h2>
  <ul>
    <li><a href="#" class="active" data-section="users">Manage Users</a></li>
    <li><a href="#" data-section="reports">Reports</a></li>
    <li><a href="#" data-section="messages">Messages</a></li>
  </ul>
</div>

<div class="main">
  <header>
    <h2>Welcome, Admin!</h2>
    <button id="logoutBtn">Logout</button>
  </header>

  <section id="usersSection">
    <h2>Manage Users</h2>
    <button id="addUserBtn" class="addBtn">Add New Lecturer</button>
    <table id="usersTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Role</th><th>Student Number</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="reportsSection" style="display:none">
    <h2>Reports</h2>
    <div class="card-container">
      <div class="card"><h3>Total Students</h3><p id="reportStudents">0</p></div>
      <div class="card"><h3>Total Lecturers</h3><p id="reportLecturers">0</p></div>
    </div>
    <h3>Course Enrollments</h3>
    <table id="enrollmentTable">
      <thead><tr><th>Course</th><th>Enrolled Students</th><th>Average Grade</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="messagesSection" style="display:none">
    <div class="message-container">
      <h3>Send Message</h3>
      <select id="messageRecipient">
        <option value="">Select Recipient</option>
      </select>
      <div class="message-list" id="messageList"></div>
      <div class="message-input">
        <input type="text" id="messageText" placeholder="Type a message...">
        <button id="sendMessageBtn">Send</button>
      </div>
    </div>
  </section>
</div>

<div id="toast"></div>

<script>
const sections = {
  users: document.getElementById("usersSection"),
  reports: document.getElementById("reportsSection"),
  messages: document.getElementById("messagesSection")
};

document.querySelectorAll(".sidebar ul li a").forEach(link=>{
  link.addEventListener("click", e=>{
    e.preventDefault();
    document.querySelectorAll(".sidebar ul li a").forEach(a=>a.classList.remove("active"));
    link.classList.add("active");
    Object.keys(sections).forEach(key=>{
      sections[key].style.display = (key===link.dataset.section) ? "block" : "none";
    });
    if(link.dataset.section==="reports") renderReports();
    if(link.dataset.section==="messages") renderRecipients();
  });
});

function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

function getUsers(){ return JSON.parse(localStorage.getItem('users')) || []; }
function saveUsers(users){ localStorage.setItem('users', JSON.stringify(users)); }
function getEnrollments(){ return JSON.parse(localStorage.getItem('enrollments')) || []; }
function getMessages(){ return JSON.parse(localStorage.getItem('messages')) || []; }
function saveMessages(msgs){ localStorage.setItem('messages', JSON.stringify(msgs)); }

function renderUsers(){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  const users = getUsers();
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.userType}</td><td>${u.studentNumber || "-"}</td>
      <td>${u.userType!=='ADMIN'?`<button class="deleteBtn" data-email="${u.email}">Delete</button>`:''}</td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll(".deleteBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const email = btn.dataset.email;
      if(confirm("Are you sure you want to delete this user?")){
        let users = getUsers();
        users = users.filter(u=>u.email!==email);
        saveUsers(users);
        renderUsers();
        showToast("✅ User deleted");
      }
    });
  });
}

document.getElementById("addUserBtn").addEventListener("click", ()=>{
  const name = prompt("Enter lecturer name:");
  const email = prompt("Enter lecturer email:");
  const password = prompt("Enter password:");
  if(!name || !email || !password){ alert("All fields are required."); return; }
  let users = getUsers();
  if(users.find(u=>u.email===email)){ alert("Email already exists."); return; }
  users.push({name,email,password,userType:"LECTURER"});
  saveUsers(users);
  renderUsers();
  showToast("✅ Lecturer added");
});

document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem('currentUser');
  window.location.href="home.html";
});

function renderReports(){
  const users = getUsers();
  document.getElementById("reportStudents").textContent = users.filter(u=>u.userType==="STUDENT").length;
  document.getElementById("reportLecturers").textContent = users.filter(u=>u.userType==="LECTURER").length;
  const enrollments = getEnrollments();
  const courses = [...new Set(enrollments.map(e=>e.course))];
  const tbody = document.querySelector("#enrollmentTable tbody");
  tbody.innerHTML = "";
  courses.forEach(course=>{
    const courseEnrollments = enrollments.filter(e=>e.course===course);
    const avgGrade = courseEnrollments.length>0?(courseEnrollments.reduce((sum,e)=>sum+e.grade,0)/courseEnrollments.length).toFixed(2):0;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${course}</td><td>${courseEnrollments.length}</td><td>${avgGrade}</td>`;
    tbody.appendChild(tr);
  });
}

// Messaging
function renderRecipients(){
  const select = document.getElementById("messageRecipient");
  select.innerHTML = `<option value="">Select Recipient</option>`;
  const users = getUsers().filter(u=>u.userType!=="ADMIN");
  users.forEach(u=>{
    const option = document.createElement("option");
    option.value = u.email;
    option.textContent = `${u.name} (${u.userType})`;
    select.appendChild(option);
  });
  renderMessages();
}

function renderMessages(){
  const list = document.getElementById("messageList");
  const recipient = document.getElementById("messageRecipient").value;
  list.innerHTML = "";
  if(!recipient) return;
  const messages = getMessages().filter(m=>m.to===recipient || m.from==="ADMIN");
  messages.forEach(m=>{
    const p = document.createElement("p");
    p.textContent = `${m.from}: ${m.text}`;
    list.appendChild(p);
  });
}

document.getElementById("sendMessageBtn").addEventListener("click", ()=>{
  const recipient = document.getElementById("messageRecipient").value;
  const text = document.getElementById("messageText").value.trim();
  if(!recipient || !text){ alert("Select recipient and type a message."); return; }
  const messages = getMessages();
  messages.push({from:"ADMIN",to:recipient,text});
  saveMessages(messages);
  document.getElementById("messageText").value = "";
  renderMessages();
  showToast("✅ Message sent");
});

document.getElementById("messageRecipient").addEventListener("change", renderMessages);

renderUsers();
</script>
</body>
</html>
